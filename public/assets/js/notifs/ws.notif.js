// Generated by CoffeeScript 1.12.5

/*
WebSocket Notification class.
Refer to the layout view.
 */

(function() {
  this.WsNotif = (function() {
    function WsNotif(wsUri, topicUri) {
      var conn, ctx, protocol;
      if (window.location.protocol === 'http:') {
        protocol = 'ws:';
      } else {
        protocol = 'wss:';
      }
      wsUri = protocol + "//" + wsUri;
      ctx = this;
      conn = new ab.Session(wsUri, function() {
        return conn.subscribe(topicUri, function(topic, data) {
          return ctx.onSub(new WsBuild(data.title, data.type));
        });
      }, function() {
        return console.log('Something went wrong. Check if the Push Notification Server is still running.');
      }, {
        'skipSubprotocolCheck': true
      });
    }

    WsNotif.prototype.onSub = function(wsBuild) {
      return this.render(wsBuild.title, wsBuild.type);
    };

    WsNotif.prototype.label = function(type) {
      var lbl;
      lbl = '';
      switch (type) {
        case 'Create':
          lbl = 'label-success';
          break;
        case 'Create Duplicate':
          lbl = 'label-primary';
          break;
        case 'Delete':
          lbl = 'label-danger';
      }
      return lbl;
    };

    WsNotif.prototype.render = function(title, type) {
      var lbl, sProj, sTitle;
      lbl = this.label(type);
      sProj = '.sidebar-menu .treeview-menu.projects';
      sTitle = sProj + " li > a > span";
      return $(sTitle + ":contains('" + title + "')").filter(function() {
        var li, n, oNotif;
        if ($.trim($(this).text()) === $.trim(title)) {
          li = $(this).closest('li');
          oNotif = li.find('#notif.project');
          oNotif.addClass(lbl);
          n = parseInt(oNotif.html());
          n = isNaN(n) || n < 0 ? 1 : n + 1;
          return oNotif.html(n);
        }
      });
    };

    return WsNotif;

  })();

  $(document).ready(function() {
    var b;
    b = $('#build-notif');
    return new WsNotif(b.data('host'), b.data('topic'));
  });

}).call(this);
